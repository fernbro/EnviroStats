---
title: 'HW5: Non-Gaussian spatial data (generalized responses)'
author: "Fern Bromley"
date: "November 21, 2025"
output:
  pdf_document: 
header-includes:
- \renewcommand*\familydefault{\sfdefault} %% this picks a sans serif font
- \usepackage[T1]{fontenc}
---

```{r setup, echo=F}
knitr::opts_chunk$set(class.source = 'number-lines', cache = T)
```
## Homework Guidelines

***Please submit your answers on Gradescope as a PDF with pages matched to question answers.***

One way to prepare your solutions to this homework is with R Markdown, which provides a way to include mathematical notation, text, code, and figures in a single document. A template `.Rmd` file is available through D2L. 

Make sure all solutions are clearly labeled, and **please utilize the question pairing tool on Gradescope**. You are encouraged to work together, but your solutions, code, plots, and wording should always be your own. Come and see me during office hours or schedule an appointment when you get stuck and can't get unstuck.

## I. Mathematical [6 pts]

The goal of the following exercise is to show that sometimes log-linear inhomogeneous Poisson processes and Poisson GLMs are equivalent probabilistic models. The equivalence occurs when the areal units used to aggregate a point pattern into counts (e.g., the central park squirrels example) match up with constant values of the predictors.

\begin{figure}[h]
\centering
\includegraphics[width = 0.6\linewidth]{fig1-1.pdf}
\caption{Example domain and partition. Points in the pattern $\mathbf{X}$ are marked by solid dots and counts of points in each subset, $n_j = n(u_j)$, are written at the center of each component of the partition. The color of each partition corresponds to the level of a predictor variable, $z(u_j)$.}
\end{figure}

(@) [6 pts] Consider a point process, $X(u)$, which takes place in a finite domain $W$ that is partitioned into $J$ compact sets. Let $u_j, \; j = 1, \dots J$ denote the $j$th set of the partition such that $\cup_{j=1}^J u_j~=~W$ and $u_j \cap u_{j^*} = \emptyset$ for $j \neq j^*$. Consider also the aggregated process $n(u_j)~=~\sum_{i = 1}^n \mathbf{1}_{x_i \in u_j}$ that is the sum of points in any finite realization of $\mathbf{X} = \{x_1, \dots, x_n\}$ occurring in each of the $J$ subsets of the partition. Suppose a predictor of interest, $Z(u)$, is piece-wise constant with value $z_j$ across each component of the partition such that $Z(u) = z_j \; \forall \; u \in u_j$. Figure 1 shows an example.

    (Option 1) Show mathematically that the likelihoods for the log-linear inhomogeneous Poisson process for $\mathbf{X}$ given by $\log(\lambda(u)) = \beta_0 + \beta_1 Z(u)$ and the GLM for $\mathbf{n}$ with a Poisson response distribution, log link, and log-expected value $\log(\lambda(u_j)) = \beta_0 + z(u_j)\beta_1 + \log(|u_j|)$ are proportional to each other up to a constant that does not depend on $\boldsymbol\beta = (\beta_0 \; \beta_1)^\top$, which therefore implies that the MLE estimators of $\boldsymbol\beta$ are the same for each model (*hint: an expression for the likelihood of a log-linear IPP is provided in BRT Ch. 9.7.4*). Note, the extra term in the GLM, $\log(|u|)$ is not a predictor and has no coefficient. It is a known quantity sometimes called an "offset".

    (Option 2) The file `HW5_1.RData` contains the realized point pattern `X` from Figure 1 above and a pixel-image `Z_pix` that provides the value of the predictor $z(u)$ at a fine grid of locations in the plane $u = (x, y)$. Use the objects to fit a log-linear model for the point pattern and estimate the coefficients $\beta_0$ and $\beta_1$. `HW5_1.RData` also contains the data frame named `aggregated` with columns `z` and `area` corresponding to $z(u_j)$ and $|u_j|$, respectively. Use the data frame to fit a GLM for the counts, $\mathbf{n}$, with a Poisson response distribution, log link function, and offset $\log(|u_j|)$. Verify these two approaches give approximately the same estimates for the coefficients $\beta_0$ and $\beta_1$.
    
```{r}
load("HW5_1.RData")
library(spatstat)
```
    
```{r}
logmod1 <- ppm(X ~ Z_pix)
summary(logmod1)
```
```{r}
glm_mod <- glm(n ~ z + offset(log(area)), aggregated, family = poisson)
summary(glm_mod)
```

## Forest Inventory and Analysis

The data for this homework come from the US Forest Service's Forest Inventory and Analysis (FIA) program, which "collects, processes, analyzes, and reports on data necessary for assessing the extent and condition of forest resources in the United States" ([**https://research.fs.usda.gov/programs/fia**](https://research.fs.usda.gov/programs/fia)). The data are publicly available, and access can be facilitated by the `rFIA` package. Two other resources I used to prepare the data for this assignment were (1) the USFS list of tree species and codes [**https://usfs-public.box.com/v/FIA-TreeSpeciesList**](https://usfs-public.box.com/v/FIA-TreeSpeciesList)), and (2) metadata about the meanings of the variables appearing in the FIA records. ([**https://research.fs.usda.gov/understory/forest-inventory-and-analysis-database-user-guide-nfi**](https://research.fs.usda.gov/understory/forest-inventory-and-analysis-database-user-guide-nfi)). You don't need to know about the data pre-processing to be able to complete this assignment, but I'm happy to share more details about what I did for those who are interested.

The file `FIA_AZ_Doulgas-Fir.csv` contains records about [**Douglas Fir**](https://en.wikipedia.org/wiki/Douglas_fir) trees in Arizona at the scale of FIA ground plots. 

\begin{figure}\centering
\includegraphics[width=4in]{sub-plot.pdf}
\caption{FIA sub-plot structure}\label{fig:sub-plot}
\end{figure}

Variable name | Definition
--------------|---------------------------------------------------------------
`PLOT`        | Plot ID
`INVYR`       | Inventory year. The year the data for the plot were collected.
`Common.Name` | Common name for tree species of interest: Douglas fir.
`DEAD`        | Number of newly dead (since last site visit) Douglas fir trees recorded at plot.
`ELEV`        | Elevation in feet at plot coordinates.
`LON`, `LAT`  | Longitude and latitude of plot.

Figure \ref{fig:sub-plot} is taken from the metadata document referenced above and shows how four sub-plots are arranged within each plot. All the sub-plots associated with a given plot have the same recorded coordinates and elevation, and the rows in `FIA_AZ_Doulgas-Fir.csv` refer to observations aggregated to the plot level. A primary goal for this homework is to try and understand patterns in the deaths of Douglas Fir trees attributable to time and elevation.

## II. Modeling counts [23 pts]

(@) [5 pts] Make a plot of the FIA plot locations with: 

    (i) map tiles in the background for context, 
    (ii) points colored by the number of dead trees recorded in a given year (you can include multiple inventory years for the same FIA plot as overlapping points), and 
    (iii) points scaled in size by the number of dead trees recorded. You may need to experiment with the relationship between point size and number of dead trees to get a reasonable figure, but make sure larger points correspond to more dead trees.

```{r}
library(tidyverse)
library(ggmap)
library(sf)
library(viridis)

plot_csv <- read.csv("FIA_AZ_Doulgas-Fir.csv")
plots <- plot_csv %>% 
  group_by(LAT, LON, PLOT) %>% 
  summarise(DEAD = sum(DEAD))
plot_loc <- st_as_sf(plot_csv, coords = c("LON", "LAT"), crs = "+proj=longlat")

st_bbox(plot_loc)
fia_map <- get_stadiamap(bbox = c(left = -113,
                                  bottom = 31,
                                  right = -108.5,
                                  top = 37.5), 
                         zoom = 8)

ggmap(fia_map)+
  geom_point(data = plot_csv, aes(x = LON, y = LAT,
                                  color = DEAD, size = DEAD),
             alpha = 0.3)+
  scale_color_viridis(option = "D")
```

(@) [3 pts] Explain in your own words why a geostatistical model with a conditionally Gaussian response is inappropriate for the number of dead trees at each plot. 

Because dead trees are recorded as counts, we should be modeling these assuming a Poisson distribution for the response.

(@) [3 pts] Fit a generalized linear model (GLM) with a Poisson response distribution and log link function to the number of dead trees. Include linear relationships for elevation and year, as well as their interaction. Report 95% confidence intervals for each estimated effect. What is the predicted number of dead trees for a plot at an elevation of 7,000 ft in the year 2024?

```{r}
library(spmodel)
glm1 <- spglm(DEAD ~ INVYR + ELEV + INVYR:ELEV, data = plot_csv, 
              family = poisson,
              spcov_type = "none")
confint(glm1)
exp(predict(glm1, newdata = data.frame(INVYR = 2024, ELEV = 7000), interval = "confidence"))
```
For a plot at 7,000 feet in the year 2024, the expected number of dead trees is approximately 3.

(@) [5 pts] Create a figure like the one below that shows the predicted number of dead trees by plot elevation for the years 2000, 2012, and 2024. **PEC.** Explain in your own words how the effect of elevation on number of dead trees appears to have changed from 2000 to 2024.

```{r}
elev <- seq(5000, 10500, 100)
yr2000 <- rep(2000, length(elev))
yr2012 <- rep(2012, length(elev))
yr2024 <- rep(2024, length(elev))

plot2000 <- data.frame(elev, yr2000);names(plot2000) <- c("ELEV", "INVYR")
plot2012 <- data.frame(elev, yr2012);names(plot2012) <- c("ELEV", "INVYR")
plot2024 <- data.frame(elev, yr2024);names(plot2024) <- c("ELEV", "INVYR")

pred2000 <- exp(predict(glm1, plot2000))
pred2012 <- exp(predict(glm1, plot2012))
pred2024 <- exp(predict(glm1, plot2024))

predictions <- data.frame(c(pred2000, pred2012, pred2024), rep(elev, 3), 
                          c(yr2000, yr2012, yr2024))
names(predictions) <- c("count", "elev", "year")

ggplot(predictions, aes(x = elev, y = count))+
  geom_point(aes(color = factor(year)))+
  theme_light()+
  labs(x = "Elevation (ft)", y = "Number of dead trees", color = "Year")
```
It is possible that in 2024, higher-elevation forests were more likely to experience beetle outbreaks or severe wildfires that caused tree mortality. Higher elevation forests could have higher tree density due to moisture availability which can increase susceptibility to density-dependent drivers of mortality.

*For all following spatial models, use projected spatial coordinates for plot location according to a UTM Zone 12 coordinate reference system.*

```{r}
plot_utm <- st_transform(plot_loc, crs = "epsg:32612")
```

(@) [4 pts] Fit a spatial GLM to counts of dead trees with a Poisson response distribution and log link function and the same predictors as the non-spatial GLM. Assume the latent spatial random effect has a Gaussian-shaped covariance function. Report 95% CIs for the regression coefficients. What is the predicted number of dead trees at the plot with ID 82202 in the year 2024?

```{r}
# fit glm:
glm_sp <- spglm(DEAD ~ INVYR + ELEV + INVYR:ELEV, data = plot_utm, 
                family =  poisson,
                spcov_type = "gaussian")
exp(confint(glm_sp))
```

```{r}
library(sf)

plot_info <- plot_utm %>% 
  select(PLOT, ELEV, geometry) %>% 
  unique()

# data setup
pred_sp <- data.frame(2024, plot_info$ELEV[which(plot_info$PLOT == 82202)], 
                      plot_info$geometry[which(plot_info$PLOT == 82202)])
names(pred_sp) <- c("INVYR", "ELEV", "geometry")
pred_sp <- st_as_sf(pred_sp)

#prediction:
predict(glm_sp, pred_sp, type = "response")
```

We predict that approximately 8 dead trees will occur in this plot in 2024.

(@) [3 pts] Compute AIC for the models with and without a spatial random effect. In addition, use cross validation to estimate predictive bias mean-square prediction error for each model. Which model shows evidence of the best fit to the data based on predictive performance?

```{r}
AIC(glm1, glm_sp)
sapply(list(glm1, glm_sp), function(x) loocv(x)[,1:3])
```
While the model without spatial effects had a smaller bias, the model with spatial dependence had smaller prediction errors and a lower AIC (better fit to the data).

## III. Modeling whether tree death occurred at all [11 pts]

Instead of modeling the counts of dead trees for each plot and inventory year, we could instead model whether *any* dead trees were recorded as a binary outcome (0 = no dead trees, 1 = at least one dead tree).

(@) [3 pts] Fit a new non-spatial logistic regression model for the binary outcome of "at least one dead tree recorded" as a function of elevation, year, and their interaction. Report 95% CIs for each regression coefficient. Qualitatively speaking, how much evidence is there for a non-zero interaction effect?

```{r}
plot_bin <- plot_utm %>% 
  mutate(DEAD = case_when(DEAD == 0 ~ 0,
                          DEAD != 0 ~ 1))

binary_glm <- spglm(DEAD ~ INVYR*ELEV, data = plot_bin, family = binomial, spcov_type = "none")
exp(confint(binary_glm))/(1+exp(confint(binary_glm)))
```
There seems to be a strong amount of evidence that there are interactions between elevation and year; CI for this effect does not include zero.

(@) [4 pts] Fit a spatial logistic regression model for the binary outcome of "at least one dead tree recorded" as a function of elevation and year and their interaction. Assume the latent spatial random effect has a Gaussian-shaped covariance function. Report 95% CIs for the regression coefficients. What is the predicted probability of recording at least one dead tree at the plot with ID 82202 in the year 2000? 2024?

```{r}
binary_spglm <- spglm(DEAD ~ INVYR*ELEV, data = plot_bin, family = binomial, spcov_type = "gaussian")
exp(confint(binary_spglm))/(1+exp(confint(binary_spglm)))
```

```{r}
# predictions:

# set up new data:
pred_b1 <- data.frame(2000, plot_info$ELEV[which(plot_info$PLOT == 82202)], 
                      plot_info$geometry[which(plot_info$PLOT == 82202)])
names(pred_b1) <- c("INVYR", "ELEV", "geometry")
pred_b1 <- st_as_sf(pred_b1)

pred_b2 <- data.frame(2024, plot_info$ELEV[which(plot_info$PLOT == 82202)], 
                      plot_info$geometry[which(plot_info$PLOT == 82202)])
names(pred_b2) <- c("INVYR", "ELEV", "geometry")
pred_b2 <- st_as_sf(pred_b2)

# predictions:
predict(binary_spglm, pred_b1, type = "response") # 2000
predict(binary_spglm, pred_b2, type = "response") # 2024
```
There is an 86% chance of observing a dead tree in the plot in 2000, and a 99% chance in 2024.

(@) [4 pts] In your opinion, do you think it makes more sense to model counts of dead trees or whether any trees died at all? Explain your reasoning. Can you think of any situation in which the approach you *did not* identify might make more sense?

In a classic ecologist/statistician way, I feel like there are equivalently interesting applications for both modeling approaches. I would be interested in modeling whether trees died at all to look at changes in the spatial extent of mortality risk. But, I would probably use the approach for modeling counts of dead trees to look at the severity of factors influencing tree mortality across space.