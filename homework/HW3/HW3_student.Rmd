---
title: 'HW3: Discrete, fixed spatial index'
author: "Fern Bromley"
date: "**DUE: 10/17 11:59pm**"
output:
  pdf_document
header-includes:
- \renewcommand*\familydefault{\sfdefault} %% this picks a sans serif font
- \usepackage[T1]{fontenc}
---

```{r setup, echo=F}
knitr::opts_chunk$set(class.source = 'number-lines', cache = T,
                      tigris_use_cache = T, warning = F, results = 'hide', fig.show = 'hide',
                      echo = F, message = F)
```

### I. Mathematical [6 pts]

(@) [6 pts] Do *either* of the following:

    (Option 1) Let $\boldsymbol{x}$ be a mean-zero multivariate normal random vector of length $n$ with precision matrix $\mathbf{Q} = \boldsymbol\Sigma^{-1}$ such that $\boldsymbol{x} \sim \mathrm{N}(\boldsymbol{0}, \mathbf{Q}^{-1})$. Show that $$\mathrm{E}(x_i|\boldsymbol{x}_{-i}) = \sum_{j \neq i} -\frac{Q_{ij}}{Q_{ii}}x_j.$$

    *Hint: You may use the fact that $x_{i} | \boldsymbol{x}_{-i}$ is normally distributed with density function proportional to the density function of $\boldsymbol{x}$*.

    (Option 2) Ch. 7.9 Exercise 12. (a) from Zimmerman and Ver Hoef:

    *12. Construct figures analogous to Figure 7.3, showing the marginal correlations corresponding to adjacent site-pairs in $3 \times 3$ and $6 \times 6$ square lattices, for each of the following, and comment on each figure:*
    
    *(a) SAR models with $\mathbf{W}$ a binary adjacency matrix and $-1\leq \rho_\mathrm{SAR} \leq 1$*

### I. Exploring the data [17 pts]

For this homework, you'll be analyzing data related to cyclist injuries in San Diego County. The County reports counts of cyclist injuries for "subregional areal" (SRA) units. SRAs are defined by The County for their own use. Roughly, each areal unit is made up of a union of several census tracts (Figure 1; SEE PDF ON GRADESCOPE). The shapefiles for this assignment were obtained [**here**](https://geo.sandag.org/portal/home/item.html?id=bf4a734115bc46d29f146f2b51107f2f) (the [**San Diego Regional Data Warehouse**](https://geo.sandag.org/portal/apps/experiencebuilder/experience/?id=fad9e9c038c84f799b5378e4cc3ed068&page=About#data_s=id%3AdataSource_1-0%3A112) has several other publicly available spatial datasets). Download the file `Subregional_Areas_2020_shapefile.zip` from D2L and unzip it in your working directory.

(@) [2 pts] **Provide executable code** (**PEC**) that uses the `sf` package to read the shapefiles in the `Subregional_Areas_2020_shapefile/` directory into R as a simple features object called `SRA`. How many SRAs are there? Verify your `SRA` boundaries look like the ones in Figure 1 (SEE PDF ON GRADESCOPE).

```{r}
library(sf)
SRA <- st_read("Subregional_Areas_2020.shp") %>% 
  st_as_sf()

plot(SRA[1])
length(unique(SRA$geometry))
```
There are 41 subregional areas.

(@) [1 pt] Use the `spdep` package to create a `nb` object that defines neighbors based on adjacency. **PEC**. What is the most neighbors any areal unit has? Fewest?

```{r}
library(spdep)

nbrs <- poly2nb(SRA)

x <- vector(length = 41)
for(i in seq(from = 1, to = 41, by = 1)){
  x[i] <- length(nbrs[[i]])
}

max(x)
min(x)
```
The largest number of neighbors for a single unit is 8, and the fewest is 2.

(@) [2 pts] Choose another method besides spatial adjacency for defining a binary neighborhood structure. Describe your method and **PEC** that creates an associated `nb` object or adjacency matrix, $\mathbf{W}$. What is the most neighbors any areal unit has? Fewest?

I've decided to designate SRAs as neighbors if they are within 10 km of each other.

```{r}
nbrs2 <- st_is_within_distance(SRA, SRA, dist = 10000)

x <- vector(length = 41)
for(i in seq(from = 1, to = 41, by = 1)){
  x[i] <- length(nbrs2[[i]])
}
max(x)
min(x)
```

```{r}
sra_buff <- st_buffer(SRA, dist = 10000)

# just kinda seeing what this looks like...
library(ggplot2)
ggplot()+
  geom_sf(data = SRA, alpha = 0.2)+
  geom_sf(data = sra_buff, color = "red", alpha = 0.2)
```

The largest number of neighbors is 13, and the smallest is 3.

Next, you'll incorporate data reported by the county on the rates of injuries to cyclists caused by vehicles in 2017. These data were obtained from the County of San Diego's public data repository [**here**](https://data.sandiegocounty.gov/Health/Motor-Vehicle-Injuries-to-Pedalcyclists/benq-pua2). The following lines of code read the data into R, and then isolate rows corresponding to SRAs and columns corresponding to variables of interest.

```{r, echo = T}
bikes_full <- read.csv("Motor_Vehicle_Injuries_to_Pedalcyclists.csv")
bikes <- bikes_full[bikes_full$GeoType == "SRA" & !is.na(bikes_full$GeoType), 
                    c("OUTCOME", "GeoName", "GeoID", "Total", "TotalRate")]
```

The variable `OUTCOME` corresponds to one of six outcomes for the cyclist (you will focus on three of them); `GeoName` gives the name assigned to an individual SRA; `GeoID` gives a unique integer label to each SRA that matches with the values in `SRA$OBJECTID`; `Total` gives the total number incidents that of the corresponding outcome type that occurred in the given SRA; `TotalRate` = `Total`/population of SRA * 100,000 gives the number of incidents per 100,000 people. Values of `NA` in `Total` and `TotalRate` correspond to incident counts for the SRA less than 5.

(@) [2 pts] How many total deaths occurred? How many total hospitalizations? How many total emergency room discharges?

```{r}
library(dplyr)

bikes_lower <- bikes %>% 
  mutate(Total = case_when(is.na(Total) ~ 0,
                           .default = Total))

bikes_upper <- bikes %>% 
  mutate(Total = case_when(is.na(Total) ~ 4,
                           .default = Total))

outcomes_lower <- bikes_lower %>% 
  group_by(OUTCOME) %>% 
  summarise(total_deaths = sum(Total))
outcomes_upper <- bikes_upper %>% 
  group_by(OUTCOME) %>% 
  summarise(total_deaths = sum(Total))
```
There were as many as zero, 88, and 961, and as few as 164, 208, and 1001 deaths, hospitilizations, and ED discharges respectively.

(@) [2 pts] Explain in words what the following 7 lines of code do. Make sure you address all 7 lines. What is the meaning of the column `TotalRateInjury` in SRA?

```{r, echo = T}
SRA <- merge(SRA, bikes[bikes$OUTCOME == "Hospitalization", c("TotalRate", "GeoID")], 
             by.x = "sra", by.y = "GeoID")
SRA <- merge(SRA, bikes[bikes$OUTCOME == "ED Discharge", c("TotalRate", "GeoID")], 
             by.x = "sra", by.y = "GeoID", suffixes = c("_Hospital", "_EDD"))
SRA$TotalRate_Hospital[is.na(SRA$TotalRate_Hospital)] <- 0
SRA$TotalRate_EDD[is.na(SRA$TotalRate_EDD)] <- 0
SRA$TotalRateInjury <- SRA$TotalRate_EDD + SRA$TotalRate_Hospital
```

Lines 1 and 2 adds attributes about hospitilizations to the original SRA sf object, by matching values in the 'sra' column of SRA and the 'GeoID' column of bikes.
Similarly, lines 3 and 4 adds attributes about ED discharges to the modified SRA sf object from lines 1&2. However, suffixes are also added to the column names that are the same between those that are merged to SRA.
Lines 5 and 6 set the rates of hospitilization and ED discharge to 0 if they equal NA respectively.
Line 7 adds together the amount of incidents resulting in hospitilization or an ED visit, giving us a total number of injuries for each feature in SRA.

One potentially relevant variable that could help explain the number of vehicle-caused cyclist injuries is the total length of bicycle routes within each SRA. The file `BIKE_ROUTES.zip` on D2L contains shapefiles for all the bicycle routes in San Diego. 

(@) [2 pts] **PEC** that: (i) reads the bike route shapefiles into R as a simple features object called `routes_sf` and (ii) verifies that the CRS for `routes_sf` matches the one used for the SRAs.

```{r}
routes_sf <- st_read("BIKE_ROUTES.shp") %>% 
  st_as_sf()

st_crs(routes_sf) == st_crs(SRA)
```

(@) [4 pts] **PEC** to make a plot similar to Figure 2 (SEE PDF ON GRADESCOPE). Make sure your map shows the SRAs of San Diego colored according to `TotalRateInjury` and the bicycle routes (hint: you may want to use the `plot()` function twice; once with `reset = FALSE`, and once with `add = TRUE`). Include your map in your submission.
```{r}
library(RColorBrewer)
# SRA <- st_as_sf(SRA)
```


```{r}
# plot.new()
breaks <- c(0, 10, 20, 30, 40, 50, 60, 70)
  
plot.new()
plot(SRA[10], reset = F, pal = brewer.pal(n = 7, name = "Reds"), breaks = breaks)
plot(routes_sf, add = T, col = "#4127AA")
```

Your next goal is to build a model for injury rate as a function of the total length of bicycles routes in a given SRA, so the first thing to do is create that predictor variable. The following code uses the `st_intersection()` and `st_length()` functions from the `sf` package to calculate the length of the bicycles routes in each SRA polygon. 

```{r, echo = T}
routes_SRA_int <- st_intersection(routes_sf['ROUTE'], SRA['sra'])
routes_SRA_int$length <- units::set_units(st_length(routes_SRA_int), "mi")
SRA_lengths <- aggregate(length ~ sra, data = routes_SRA_int, FUN = sum)
SRA <- merge(SRA, SRA_lengths, by = "sra", all.x = T)
SRA$length[c(38, 40)] <- 0
```

(@) [2 pts] Explain what each of the 5 lines in the code chunk above do. Be sure to explain why the last line about SRAs #38 and #40 is included.

Line 1 finds pairs bike routes and SRAs that they overlap.
Line 2 adds a column which computes the length of each pair of overlaps in miles.
Line 3 creates a data frame from summing the lengths of overlapping bike paths for each SRA.
Line 4 merges that data frame with the length information to the SRA feature to add these lengths as attributes to each SRA.
Line 5 sets the length equal to zero for SRAs with null values resulting in a lack of information generated from line 1 (due to an absence of bike paths).

### II. Statistical models [17 pts]

(@) [4 pts] **PEC** that fits a traditional linear model for `TotalRateInjury` as function of the miles of bicycle routes in the SRA assuming independent residuals. Give a 95\% confidence interval for the effect of miles of bicycles routes. Make a map of the SRAs colored according to the residuals from the linear model. Use a diverging color scheme centered at 0 (hint: you may need to set the `breaks` argument in `plot()`).

```{r}
linmod <- splm(TotalRateInjury ~ length, data = SRA, spcov_type = "none")
confint(linmod)
```

For every additional mile of bicycle routes, there were an additional 0.14 - 0.39 deaths per 100,000 people.

```{r}
SRA$linear_res <- residuals(linmod)
plot(SRA['linear_res'], 
     pal = brewer.pal(n = 8, name = "RdYlBu"),
     breaks = c(-40, -30, -20, -10, 0, 10, 20, 30, 40))
```

(@) [6 pts] **PEC** that fits the same linear model while accounting for residual spatial dependence using a CAR model based on the adjacency network from question (2). Compare the models with and without spatial dependence using AIC and leave-one-out cross-validation. Is there evidence in favor of including the "small" scale spatial effect?

```{r}
nbrs1 <- st_intersects(SRA, remove_self = T)

carmod <- spautor(TotalRateInjury ~ length, data = SRA, 
                  spcov_type = "car", W = as.matrix(nbrs1))

rbind(c("linear", loocv(linmod)), c("car", loocv(carmod)))
AIC(linmod, carmod)
```
There is some evidence that the CAR model performed better. Compared to the linear model, the AIC and prediction error are lower and the "R2"(ish) is higher.

(@) [3 pts] Give a 95\% confidence interval for the effect of miles of bicycle routes based on the CAR model from (10). How does it compare to the interval you found using the linear model *without* accounting for residual spatial dependence?
```{r}
confint(carmod)
```

CAR modeling estimates that for each additional bike route mile, there are 0.06 - 0.29 additional deaths per 100,000 people. This model produced a slightly narrower confidence interval, and the mean of the estimate was lower.

(@) [4 pts] Fit another linear model with spatial dependence (could be another CAR model, but need not be) based on your alternative neighborhood structure from question (3). Compare the two model fits using a predictive score of your choice. Point out differences/similarities you notice in both the "large" and "small" scale effects.

```{r}
carmod2 <- spautor(TotalRateInjury ~ length, data = SRA, 
                  spcov_type = "car", W = as.matrix(nbrs2))

rbind(loocv(carmod), loocv(carmod2))
```